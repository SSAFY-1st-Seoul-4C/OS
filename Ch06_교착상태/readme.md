## 교착 상태(Deadlock)

### 교착 상태란?

- 자원이 한정적인 상황에서 두 개 이상의 프로세스가 각자 먼저 확보한 자원을 가진 채 상대방의 자원을 필요로 할 경우, 외부로부터의 조치가 없는 한 이들은 아무 일도 못하고 계속 기다려야 할 것이다. 이러한 상황을 교착 상태라 한다.


### 6.1.1 자원이란?

* 먼저 `선점 가능성`에 따라 두 가지로 나뉘는데, CPU나 메모리와 같은 자원처럼 한 프로세스에 의해 사용 도중 선점(Preemption)되어 다른 프로세스에게 할당(Allocation)해 주었다가 이 후 다시 원래의 프로세스에게 돌려주어도 되는 자원들을 선점 가능(Preemptible, 운영체제에 의해 사용 도중 뺏길 수 있는) 자원이라고 하고, 이러한 선점이 불가능한 자원 즉, 선점이 될 경우 자원을 뺏긴 프로세스는 정상적인 진행을 포기해야 하는 불이익을 받게 되는 경우의 자원을 선점 불가능(Nonpreemptible) 자원이라고 한다. 물론 시스템은 이러한 상황을 원치 않으므로 선점 불가능 자원은 사용 도중 뺏을 수 없도록 하고 있다. 예를 들어, 다수의 사용자에게 공유되어 사용 중인 프린터에서 한 사용자가 프린트를 하는 도중에 다른 사용자에게 선점되도록 한다면 프린터 용지에는 여러 사용자의 데이터가 섞여 버릴 수 있고 이것은 누구도 원치 않는 결과가 될 것이다. 선점이 가능토록 자원을 활용하는 이유는 다중 프로그래밍의 성공을 위해서이며, 선점 불가능 자원은 시스템의 정상적인 진행을 위해 정해진다는 점을 이해하자.
* 다음으로 `자원이 사용되어지는 방식`에 따라 나눌 수 있는데, 한 프로세스에게 할당된 자원을 동시에 다른 프로세스가 할당받아 같이 사용할 수 있는지의 여부에 따라 공유 가능(Sharable) 자원과 배타적 사용(Exclusive Use) 자원으로 분류된다. 배타적 사용 자원으로 CPU, 메모리, 테이프, 버퍼(Buffer), 키보드와 모니터 등이 있으며, 공유 가능 자원으로는 공유 가능한 프로그램(시스템 프로그램이나 유틸리티 프로그램 등)과 공유 데이터 등이 있다.
* 또 다른 관점에서 `자원의 속성`에 따른 분류를 해보면, 먼저 할당된 자원이 사용 후 반납(Release)되었을 때 자원 자체는 계속 존재하여 또 다른 프로세스에게 할당이 가능하다면 그 자원은 순차적 재사용 가능(Serially Reusable) 자원이라 하는데 이러한 자원은 시스템에서 프로세스들이 아무리 사용해도 없어지지 않고 영구히 존재하는 자원으로 CPU, 메모리, 하드디스크, 버퍼, 프로그램 등이 있다. 반대로 사용 후 사라지는 자원은 소모성(Consumable) 자원에 해당하고 일시적으로 생성되었다가 사용된 후 없어지는 시그널이나 메시지 등이 여기에 해당된다.
​

### 6.1.3 교착 상태의 원인은?

- 시스템이 가지고 있는 한정적인 자원보다 사용하고자 하는 프로세스들의 요청이 더 많기 때문이다.
- 아래 4가지 조건들이 모두 갖춰질 때 교착 상태가 발생하게 되며, 만약 이 중 한 가지 조건이라도 생기지 않도록 할 수 있다면 교착 상태는 절대로 발생하지 않는다.
1. 자원의 배타적인 사용
  - 교착 상태의 발생이 시스템이 보유한 한정적인 자원에 대한 프로세스들의 사용 경쟁 때문이라고 했을 때, 만약 자원이 한정적이라도 모두 공유 가능한 - 여러 프로세스들이 동시에 사용 가능한 - 자원이라면 교착상태는 발생할 수 없다.
  - 시스템이 보유한 자원 중 배타적 사용이 요구되는 자원 때문에 교착 상태가 발생하는 원인이 되는 것이다. 이런 것을 상호배제 조건(Mutual Exclusion Condition)이라고도 한다.
2. 자원의 부분 할당(Partial Allocation)
  -  여러분은 프로세스들이 실행 과정에서 필요한 자원을 확보하고 계속 실행을 해 나가는 도중, 추가로 필요한 자원을 요청했다가 대기 상태가 되면서 교착 상태로 한 걸음 다가서게 된다는 사실을 눈치챘을 것이다. 바꿔 말해 각각의 프로세스는 자신의 실행 전체 과정에서 필요한 자원을 필요할 때마다 일부분씩 확보, 실행해 나가다가 어느 시점에 할당이 불가능한 자원 때문에 이미 확보된 자원들을 소유한채 대기 상태가 되어 버리는 과정을 겪으면서 교착 상태에 빠질 가능성을 높이는 것이다. 보유와 대기(Hold & Wait) 조건이라 부르기도 한다.
3. 자원의 선점 불가능성
  - 자원의 종류에는 선점이 불가능한 것도 있음을 배웠다. 선점이 불가능한 자원을 억지로 선점이 되도록 하면 어떨까? 선점의 권한이 주어진 프로세스들은 자원 때문에 대기할 필요가 없으므로 교착 상태라는 것을 없앨 수 있다. 하지만 자신의 자원을 선점당한 프로세스들은 정상적인 실행을 포기해야 한다. 왜냐하면 선점을 당한다는 말은 그 자원을 가지고 해왔던 지금까지의 일을 잃게 된다는 뜻이다. 결국 자원의 선점 불가능성을 고수할 경우 교착 상태의 원인이 되는 것을 알 수 있다. 이것은 비선점(No Preemption) 조건이라고도 한다.
4. 자원에 대한 환형 대기(Circular-Wait)
  - 프로세스들이 자신의 자원은 보유한 채로 서로 상대방의 자원을 요청하고 결과적으로 대기 상태가 되어 버리는 일련의 과정에서 교착 상태가 발생 가능하다고 하였다.
​


### 6.2 교착 상태의 해결

- 교착 상태의 해결을 위한 기법들은 4가지로 분류할 수 있다.
- 첫째가 예방(Prevention) 기법이고 두 번째는 회피(Avoidance) 기법이며 세 번째가 탐지(Detection), 마지막으로 복구(Recovery) 기법이다. 예방은 교착 상태를 아예 발생되지 않도록 하겠다는 것이며, 회피 역시 프로세스들이 교착 상태를 피해가도록 하는 방법이다. 반면에, 탐지는 교착 상태가 발생되도록 놓아두었다가 발생 시 또는 발생 후에 교착 상태를 탐지하여 조치하는 방법이며 이것은 복구 작업을 수반하므로 탐지와 복구는 같이 묶어 하나로 보아도 좋다.
​

#### 6.2.1 예방 기법

- 교착 상태가 발생되는 4가지 원인 중 하나를 없앰으로써 - 발생 원인의 하나를 제거함으로써 - 교착 상태의 발생 자체를 막도록 한 방법

##### 6.2.1.1 자원의 배타적 사용 조건을 배제

- 이것은 모든 자원을 공유 가능 자원으로 하여 교착 상태의 발생을 차단하겠다는 의도이다. 불행하게도 시스템이 보유한 자원 중에는 배타적으로 사용할 수밖에 없는 자원들도 있다. 자원을 설명하면서 예를 든 프린터나 테이프 장치 등은 프로세스들이 차례로 사용해야 하는 자원으로 공유가 가능한 자원이 될 수 없다. 결론적으로, 이 조건을 배제하여 교착 상태를 예방하기는 불가능하다.

##### 6.2.1.2 자원의 부분 할당을 배제

* 부분 할당을 없앤다는 말은 모두 할당(Total Allocation)하겠다는 뜻이 된다. 즉, 프로세스들은 각자 자신이 필요한 모든 자원을 미리 할당받아 실행을 시작하도록 하는 방법이다. 이렇게 되면 실행 도중 자원을 요구할 일도 없고 따라서 대기 상태가 될 일도 없게 될 것이며 결과적으로 교착 상태는 발생될 수 없는 것이다.
* 위에서 설명된 내용을 다르게 표현하면 필요한 모든 자원이 확보되지 못한 프로세스는 대기 상태에 있게 된다는 것과 같다. 사실 일이 시작될 때부터 모든 자원이 있어야 할 경우란 거의 없으며 당장은 그 중 몇 개만이 실제로 사용되는 것이 일반적인 상황일 것이다. 즉, 일부 자원만 확보되면 시작할 수 있음에도 불구하고 모든 것을 할당받을 때까지 기다려야 하고, 할당이 가능했던 일부 자원들은 사용되지 못해 낭비되는 현상이 발생하게 되는 것이다. 모든 자원이 확보되어 실행을 시작할 경우에도 시작 시점에서 할당된 자원들이 실제로 사용되는 시점까지는 역시 낭비되는 것이다. 한마디로 심각한 자원의 낭비가 초래되는 방법이라는 것을 알아두자.

##### 6.2.1.3 자원의 선점 불가능을 배제

- 모든 자원이 선점 가능하도록 할 경우 교착 상태는 발생하지 않을 것이라는 점을 고려한 해결책이다. 물론 가능한 말이기는 하지만 선점이 불가능한 자원을 선점 가능한 자원으로 만들 경우 발생될 문제 역시 만만치가 않을 것이다.